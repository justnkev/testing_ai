{% extends 'base.html' %}
{% block topbar %}
<div>
  <small>Progress</small>
  <h2 style="margin:0.4rem 0 0;">Capture the signals that matter.</h2>
  <p style="margin:0.6rem 0 0; max-width:460px;">Check-ins across movement, nourishment, rest, and habits sync directly with your dashboard to inform new guidance.</p>
</div>
<div class="topbar-meta">
  <a class="fv-button fv-button--ghost" href="{{ url_for('main.dashboard') }}">Dashboard</a>
  <a class="fv-button fv-button--ghost" href="{{ url_for('main.plan') }}">Plan</a>
</div>
{% endblock %}
{% block content %}
<div class="grid-responsive">
  <section class="surface-card">
    <div class="section-header">
      <div>
        <small>Daily check-in</small>
        <h2 style="margin:0.4rem 0 0;">Log your progress</h2>
        <p>Capture workouts, meals, sleep, and habit wins. Each log powers your dashboard metrics.</p>
      </div>
    </div>
    <form method="post" class="form-grid">
      <div>
        <label for="workout">Workouts</label>
        <input id="workout" name="workout" placeholder="Strength session, mobility, rest day...">
      </div>
      <div>
        <label for="meals">Meals</label>
        <textarea id="meals" name="meals" rows="2" placeholder="Highlights, challenges, cravings..."></textarea>
      </div>
      <div>
        <label for="sleep">Sleep</label>
        <input id="sleep" name="sleep" placeholder="Hours slept or quality notes">
      </div>
      <div>
        <label for="habits">Habits</label>
        <textarea id="habits" name="habits" rows="2" placeholder="Meditation, hydration, gratitude..."></textarea>
      </div>
      <div>
        <button class="fv-button fv-button--primary" type="submit">Save log</button>
      </div>
    </form>
  </section>
  {% if health_summary.has_samples %}
  <section class="surface-card">
    <div class="section-header">
      <div>
        <small>Apple Health sync</small>
        <h2 style="margin:0.4rem 0 0;">Imported metrics</h2>
        {% if health_summary.last_sync_display %}
        <p class="stat-detail" style="margin:0.4rem 0 0;">Last sync: {{ health_summary.last_sync_display }}</p>
        {% endif %}
      </div>
    </div>
    <div class="data-grid">
      <article class="surface-card stat-card">
        <span class="stat-label">Steps (7d)</span>
        <div class="stat-value">{{ health_summary.steps_7d|int }}</div>
        <div class="stat-detail">{{ health_summary.steps_30d|int }} in 30 days</div>
      </article>
      <article class="surface-card stat-card">
        <span class="stat-label">Active kcal</span>
        <div class="stat-value">{{ health_summary.active_energy_7d|round|int }}</div>
        <div class="stat-detail">Burned via Apple Health</div>
      </article>
      <article class="surface-card stat-card">
        <span class="stat-label">Calories in</span>
        <div class="stat-value">{{ health_summary.dietary_energy_7d|round|int }}</div>
        <div class="stat-detail">Consumed (HealthKit)</div>
      </article>
      <article class="surface-card stat-card">
        <span class="stat-label">Sleep hours</span>
        <div class="stat-value">{{ health_summary.sleep_hours_7d|round(1) }}</div>
        <div class="stat-detail">Total across past 7 nights</div>
      </article>
      <article class="surface-card stat-card">
        <span class="stat-label">Heart rate</span>
        {% if health_summary.heart_rate.avg is not none %}
        <div class="stat-value">{{ health_summary.heart_rate.avg }}</div>
        <div class="stat-detail">{{ health_summary.heart_rate.min }}–{{ health_summary.heart_rate.max }} bpm</div>
        {% else %}
        <div class="stat-value">—</div>
        <div class="stat-detail">No samples yet</div>
        {% endif %}
      </article>
    </div>
    <div style="overflow-x:auto; margin-top:1.5rem;">
      <table style="width:100%; border-collapse:collapse; font-size:0.95rem;">
        <thead>
          <tr style="text-align:left; border-bottom:1px solid var(--color-border);">
            <th style="padding:0.5rem 0.75rem;">Date</th>
            <th style="padding:0.5rem 0.75rem;">Steps</th>
            <th style="padding:0.5rem 0.75rem;">Active kcal</th>
            <th style="padding:0.5rem 0.75rem;">Calories in</th>
            <th style="padding:0.5rem 0.75rem;">Sleep (hrs)</th>
            <th style="padding:0.5rem 0.75rem;">HR avg</th>
            <th style="padding:0.5rem 0.75rem;">HR range</th>
          </tr>
        </thead>
        <tbody>
          {% for day in health_summary.daily %}
          <tr style="border-bottom:1px solid var(--color-border);">
            <td style="padding:0.5rem 0.75rem; white-space:nowrap;">{{ day.date }}</td>
            <td style="padding:0.5rem 0.75rem;">{{ day.steps }}</td>
            <td style="padding:0.5rem 0.75rem;">{{ day.active_energy|round(1) }}</td>
            <td style="padding:0.5rem 0.75rem;">{{ day.dietary_energy|round(1) }}</td>
            <td style="padding:0.5rem 0.75rem;">{{ day.sleep_hours|round(2) }}</td>
            <td style="padding:0.5rem 0.75rem;">{{ day.heart_rate_avg if day.heart_rate_avg is not none else '—' }}</td>
            <td style="padding:0.5rem 0.75rem;">
              {% if day.heart_rate_min is not none %}
              {{ day.heart_rate_min }}–{{ day.heart_rate_max }}
              {% else %}
              —
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>
  {% endif %}
  <section class="surface-card">
    <div class="section-header">
      <div>
        <small>History</small>
        <h2 style="margin:0.4rem 0 0;">Timeline</h2>
      </div>
    </div>
    {% if logs %}
    <div class="timeline-rail">
      {% for log in logs|reverse %}
      <article class="timeline-item">
        <div class="message-meta">{{ log.timestamp|default('Recent') }}</div>
        {% if log.workout %}<p><strong>Workout:</strong> {{ log.workout }}</p>{% endif %}
        {% if log.meals %}<p><strong>Meals:</strong> {{ log.meals }}</p>{% endif %}
        {% if log.calories is not none %}
        <p><strong>Nutrition:</strong> ~{{ log.calories }} kcal{% if log.macros %} <span class="stat-detail">{{ log.macros }}</span>{% endif %}</p>
        {% elif log.macros %}
        <p><strong>Nutrition:</strong> {{ log.macros }}</p>
        {% endif %}
        {% if log.estimation_notes %}<p class="stat-detail">{{ log.estimation_notes }}</p>{% endif %}
        {% if log.sleep %}<p><strong>Sleep:</strong> {{ log.sleep }}</p>{% endif %}
        {% if log.habits %}<p><strong>Habits:</strong> {{ log.habits }}</p>{% endif %}
      </article>
      {% endfor %}
    </div>
    {% else %}
    <p class="stat-detail">No entries yet. Record your first check-in to begin charting progress.</p>
    {% endif %}
  </section>
</div>
{% endblock %}
