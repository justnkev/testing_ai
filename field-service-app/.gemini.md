# Field Service App - Development Notes

## Overview
A Next.js 16 field service management application for scheduling jobs, managing customers, and handling technician workflows. Built with Supabase for authentication and database, Stripe for payments, and a mobile-first design for technicians.

---

## Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                        Next.js 16 App                           │
├─────────────┬─────────────┬─────────────┬───────────────────────┤
│   Admin     │   Mobile    │   Customer  │       API             │
│  Dashboard  │  Technician │   Portal    │     Routes            │
│  /dashboard │  /jobs/[id] │   /portal   │    /api/*             │
└─────────────┴─────────────┴─────────────┴───────────────────────┘
                              │
       ┌──────────────────────┼──────────────────────┐
       ▼                      ▼                      ▼
┌─────────────┐       ┌─────────────┐       ┌─────────────┐
│  Supabase   │       │   Stripe    │       │   Resend    │
│  Database   │       │  Payments   │       │   Email     │
│  Auth + RLS │       │  Checkout   │       │   Delivery  │
└─────────────┴───────┴─────────────┴───────┴─────────────┘
```

---

## Modules

### 1. Admin Dashboard (`/dashboard`)
- **Jobs**: Create, edit, schedule, and track service jobs
- **Customers**: Customer CRUD with portal link generation
- **Calendar**: Drag-drop scheduling with technician assignment
- **Settings**: Business configuration

### 2. Mobile Technician View (`/dashboard/jobs/[id]`)
- Job check-in/check-out workflow
- Photo upload with Supabase Storage
- Task checklist completion
- Customer signature capture
- Real-time status updates

### 3. Customer Portal (`/portal/[token]`)
- Token-based authentication (no login required)
- View pending estimates and approve with signature
- Pay invoices via Stripe Checkout
- View service history (read-only)
- Business branding from `business_settings` table

### 4. API Routes (`/api`)
- `/api/jobs/[id]` - Job CRUD operations
- `/api/photos/upload` - Photo upload to Supabase Storage
- `/api/stripe/create-checkout-session` - Stripe payment initiation
- `/api/stripe/webhook` - Stripe payment confirmation

---

## Database Schema (Supabase)

| Table | Purpose |
|-------|---------|
| `fs_customers` | Customer records |
| `fs_jobs` | Service jobs with scheduling |
| `portal_tokens` | Customer portal access tokens |
| `estimates` | Job estimates with approval workflow |
| `invoices` | Customer invoices with Stripe integration |
| `business_settings` | Portal branding and business info |

---

## Server Actions (`/lib/actions`)

| File | Responsibility |
|------|----------------|
| `jobs.ts` | Job CRUD, status updates |
| `customers.ts` | Customer management |
| `calendar.ts` | Calendar/scheduling operations |
| `job-execution.ts` | Check-in, photos, signatures, completion |
| `portal-auth.ts` | Token generation, validation, email sending |
| `portal-estimates.ts` | Estimate fetch and approval |
| `portal-invoices.ts` | Invoice fetch and payment marking |
| `archive.ts` | Soft delete and restoration |

---

## Supabase Client Usage

### ⚠️ Critical: RLS and Public Access

When implementing public-facing features (like customer portals) that don't require user authentication, the standard `createClient()` function won't work because it uses the **anon key** which is subject to Row Level Security (RLS).

**Solution**: Use `createServiceClient()` from `@/lib/supabase/service`:

```typescript
import { createServiceClient } from '@/lib/supabase/service';

// This bypasses RLS - use only on server-side
const supabase = createServiceClient();
```

### When to Use Each Client

| Client | Use Case | RLS |
|--------|----------|-----|
| `createClient()` | Authenticated user operations | ✅ Enforced |
| `createServiceClient()` | Portal token validation, admin operations, webhooks | ❌ Bypassed |

> ⚠️ **Warning**: Never expose the service role key to the client. Only use `createServiceClient()` in server actions and API routes.

---

## Environment Variables

```bash
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://xxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJ...
SUPABASE_SERVICE_ROLE_KEY=eyJ...  # For bypassing RLS

# Stripe
STRIPE_SECRET_KEY=sk_test_...
STRIPE_PUBLISHABLE_KEY=pk_test_...
STRIPE_WEBHOOK_SECRET=whsec_...

# Email
RESEND_API_KEY=re_...

# Notifications
TWILIO_ACCOUNT_SID=AC...
TWILIO_AUTH_TOKEN=...
TWILIO_PHONE_NUMBER=+1...
```

---

## Key Components

### UI Components (`/components/ui`)
Based on shadcn/ui - Button, Card, Sheet, Dialog, Table, etc.

### Feature Components
- `job-table.tsx` - Admin job list with status badges
- `job-card-list.tsx` - Mobile-friendly job cards
- `customer-list.tsx` - Customer cards with actions
- `calendar/` - Calendar view with drag-drop

### Portal Components (`/components/portal`)
- `PortalHeader.tsx` - Business branding header
- `EstimateCard.tsx` / `InvoiceCard.tsx` - Action cards
- `EstimateActions.tsx` - Approval with signature
- `InvoicePayment.tsx` - Stripe Checkout integration
- `GeneratePortalLinkButton.tsx` - Admin link generation

### Mobile Components (`/components/mobile`)
- `mobile-job-client.tsx` - Full job execution view
- `signature-pad.tsx` - Customer signature capture
- `task-checklist.tsx` - Job task completion

---

## Testing

### Portal Test URL
- Token: `test-1769132977587`
- URL: http://localhost:3000/portal/test-1769132977587

### Stripe Test Cards
- Success: `4242 4242 4242 4242`
- Decline: `4000 0000 0000 0002`

---

## Common Patterns

### Server Action Pattern
```typescript
'use server';
import { createClient } from '@/lib/supabase/server';

export async function myAction(): Promise<{ success: boolean; error?: string }> {
  const supabase = await createClient();
  // ... database operations
}
```

### Protected Route Pattern
All `/dashboard/*` routes require authentication via Supabase Auth middleware.

### Portal Route Pattern
`/portal/[token]` routes validate token in page component and redirect to `/portal/expired` if invalid.
