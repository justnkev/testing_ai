# ETA System - Development Notes

## Overview
The **ETA System** (Entrepreneurship Through Acquisition) is a Python CLI discovery engine for a search fund. It identifies small-to-medium businesses (SMBs), enriches them with financial and contact data, and generates hyper-personalized cold outreach emails using the "search fund" angle.

---

## Architecture

```
┌──────────────────────────────────────────────────────────────────┐
│              main.py (CLI)  OR  ui.py (Streamlit)                │
├──────────┬──────────┬──────────┬──────────┬──────────┬───────────┤
│ Searcher │ Enricher │ Analyzer │ Drafter  │ Database │ Prospeo   │
│ (Serper) │(Apollo + │(Gemini)  │(Gemini)  │(Supabase)│ (Email)   │
│          │ Gemini)  │          │          │          │           │
└──────────┴──────────┴──────────┴──────────┴──────────┴───────────┘
         │         │          │         │          │         │
         ▼         ▼          ▼         ▼          ▼         ▼
   google.serper  apollo.io  Gemini   Gemini    Supabase  Prospeo
     .dev/search  org/enrich 2.5-flash 2.5-flash  Postgres  Enrich
```

### Pipeline Stages
1. **SEARCH** — Serper.dev Google Search API discovers companies by industry + geography
2. **ENRICH** — Apollo `organizations/enrich` for company data (employees, revenue) + Gemini for contact extraction from websites
3. **ANALYSE** — Gemini 2.5 Flash summarises company website value propositions
4. **DRAFT** — Gemini 2.5 Flash generates personalized search-fund outreach emails
5. **SAVE** — Upsert leads into Supabase `eta_leads` table (dedup on company_name + website)
6. **EXPORT** — Write `leads_output.csv`

---

## Modules

### `eta/searcher.py`
- Uses **Serper.dev** POST API with `X-API-KEY` header
- Paginating search with configurable `top_n` limit
- Returns lead stubs with company name, website, industry, region

### `eta/enricher.py`
- **3-Tier Contact Discovery Strategy**:
  1. **Website Scraping**: Fetches Home/About/Team pages. Uses Gemini to extract contact info.
  2. **Gemini Grounding**: Fallback if scraping fails. Uses Google Search Grounding to find leadership names.
  3. **Prospeo API** (Tier 3): User-initiated verified email lookup (`enrich-person`).
- **Apollo**: Uses `organizations/enrich` for company data.
- **Rate Limiting**: Implements delays and retries to handle API limits (Gemini 5 RPM free tier).

### `eta/analyzer.py`
- Fetches company homepage, extracts text with BeautifulSoup
- Sends first 6000 chars to Gemini 2.5 Flash for value-prop summary
- Handles 403s and SSL errors gracefully (skips analysis, doesn't crash)

### `eta/drafter.py`
- Takes lead data + value-prop summary → Gemini 2.5 Flash → personalized email
- Uses search-fund messaging: honoring legacy, seeking to operate, not a PE firm
- Mentions specific details from the company's services when analysis data is available

### `eta/ui.py`
- **Streamlit Dashboard**: Professional dark-mode UI for the engine.
- **Prospeo Integration**: User-initiated email lookup section.
- **Features**: Live pipeline status, interactive lead table, export (CSV/JSON).

### `eta/database.py`
- Supabase client via `supabase-py`
- `UNIQUE(company_name, website)` constraint prevents duplicate leads
- Uses `upsert` with `on_conflict` for idempotent writes

### `eta/models.py`
- Pydantic v2 models: `Lead`, `SearchFilters`, `EnrichmentResult`
- Financial fields: `revenue`, `ebitda`, `sde`, `profit`, `employees`, `for_sale`

### `eta/utils.py`
- `@retry` decorator with exponential backoff
- Logging setup (structured, avoids print statements)

---

## Environment Variables

Located in `eta-system/.env`:

| Variable | Service | Notes |
|----------|---------|-------|
| `GEMINI_API_KEY` | Google AI | Used for analysis, drafting, and contact extraction |
| `SERPER_API_KEY` | Serper.dev | Google Search API — NOT the same as SerpApi (serpapi.com) |
| `APOLLO_API_KEY` | Apollo.io | Must have API scopes selected in Apollo Developer Portal |
| `SUPABASE_URL` | Supabase | ETA-specific project: `xsynxzlszezjiehmqivh` |
| `SUPABASE_SERVICE_ROLE_KEY` | Supabase | Service role key for bypassing RLS |
| `PROSPEO_API_KEY` | Prospeo | **Optional**. Used for Tier 3 verified email lookup. |

### API Key Gotchas
- **Serper.dev vs SerpApi**: Two completely different services. Serper uses `POST https://google.serper.dev/search` with `X-API-KEY` header. SerpApi uses `GET https://serpapi.com/search` with `api_key` param.
- **Apollo API scopes**: When creating an API key in Apollo Developer Portal, you must select specific API endpoints. Without scopes, the key returns 403. Free-tier only supports `organizations/enrich`, `organizations/search`, etc. — people search is paid-only.
- **Apollo auth**: API key must be in `X-Api-Key` header (body param deprecated).

---

## Database Schema

**Supabase project**: `xsynxzlszezjiehmqivh`
**Table**: `eta_leads`

| Column | Type | Notes |
|--------|------|-------|
| `id` | BIGINT (identity) | Primary key |
| `company_name` | TEXT NOT NULL | |
| `website` | TEXT | |
| `industry` | TEXT | |
| `region` | TEXT | |
| `contact_name` | TEXT | "Manual Research Needed" if not found |
| `contact_email` | TEXT | "Manual Research Needed" if not found |
| `contact_title` | TEXT | |
| `revenue` | DOUBLE PRECISION | From Apollo org enrichment |
| `ebitda` | DOUBLE PRECISION | Not yet populated by any source |
| `sde` | DOUBLE PRECISION | Not yet populated by any source |
| `profit` | DOUBLE PRECISION | Not yet populated by any source |
| `employees` | INTEGER | From Apollo org enrichment |
| `for_sale` | BOOLEAN | Default false |
| `value_proposition` | TEXT | Gemini-generated summary |
| `email_draft` | TEXT | Gemini-generated outreach email |
| `status` | TEXT | `new`, `enriched`, `manual_research_needed` |
| `created_at` | TIMESTAMPTZ | |
| `updated_at` | TIMESTAMPTZ | |

**Constraints**: `UNIQUE(company_name, website)`

---

## MCP Servers

The Supabase MCP server for this project is configured as `supabase-eta` in the global MCP config. Use `mcp_supabase-eta_*` tools for database operations on this project's Supabase instance.

---

## CLI Usage

```bash
cd eta-system

# Basic run
python main.py --industry "Landscaping" --region "TX"

# With limits
python main.py --industry "HVAC" --region "North Carolina" --top-n 5

# Custom output
python main.py --industry "Plumbing" --region "FL" --top-n 10 --output plumbing_fl.csv
```

### Dashboard Usage
```bash
python -m streamlit run ui.py
```

---

## Known Limitations
- **Contact discovery**: Tiers 1 & 2 are great for names but often miss emails on public pages. Tier 3 (Prospeo) fixes this (costs credits).
- **Financial data**: Only `employees` and `revenue` come from Apollo. EBITDA, SDE, and Profit columns exist but have no data source yet.
- **For-sale flag**: Defaults to `false`. No automated detection implemented.
- **SSL on Windows**: Some sites fail with `CERTIFICATE_VERIFY_FAILED` due to Windows Python SSL certificate bundle. Does not crash the pipeline.
- **Aggregator results**: Searches sometimes return aggregator sites (Houzz, Yelp) rather than actual companies. More specific search queries help.
- **Python 3.14 Compatibility**: Requires `protobuf>=5.0` to avoid `TypeError: Metaclasses with custom tp_new are not supported`. This is enforced in `requirements.txt`.
