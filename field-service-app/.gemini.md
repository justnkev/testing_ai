# Field Service App - Development Notes

## Overview
A Next.js 16 field service management application for scheduling jobs, managing customers, and handling technician workflows. Built with Supabase for authentication and database, Stripe for payments, and a mobile-first design for technicians.

---

## Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                        Next.js 16 App                           │
├─────────────┬─────────────┬─────────────┬───────────────────────┤
│   Admin     │   Mobile    │   Customer  │       API             │
│  Dashboard  │  Technician │   Portal    │     Routes            │
│  /dashboard │  /jobs/[id] │   /portal   │    /api/*             │
└─────────────┴─────────────┴─────────────┴───────────────────────┘
                              │
       ┌──────────────────────┼──────────────────────┐
       ▼                      ▼                      ▼
┌─────────────┐       ┌─────────────┐       ┌─────────────┐
│  Supabase   │       │   Stripe    │       │   Resend    │
│  Database   │       │  Payments   │       │   Email     │
│  Auth + RLS │       │  Checkout   │       │   Delivery  │
└─────────────┴───────┴─────────────┴───────┴─────────────┘
```

---

## Modules

### 1. Admin Dashboard (`/dashboard`)
- **Jobs**: Create, edit, schedule, and track service jobs
- **Customers**: Customer CRUD with portal link generation
- **Calendar**: Drag-drop scheduling with technician assignment
- **Settings**: Business configuration
- **Inventory**: Parts & Stock management
- **Analytics**: Revenue, Service Type, and Lead Source charts

### 2. Mobile Technician View (`/dashboard/jobs/[id]`)
- Job check-in/check-out workflow
- Photo upload with Supabase Storage
- Task checklist completion
- **Parts Usage**: Add parts from inventory (auto-decrements stock)
- Customer signature capture
- Real-time status updates

### 3. Customer Portal (`/portal/[token]`)
- Token-based authentication (no login required)
- View pending estimates and approve with signature
- Pay invoices via Stripe Checkout
- View service history (read-only)
- Business branding from `business_settings` table

### 4. API Routes (`/api`)
- `/api/jobs/[id]` - Job CRUD operations
- `/api/photos/upload` - Photo upload to Supabase Storage
- `/api/stripe/create-checkout-session` - Stripe payment initiation
- `/api/stripe/webhook` - Stripe payment confirmation

---

## Database Schema (Supabase)

| Table | Purpose |
|-------|---------|
| `fs_customers` | Customer records |
| `fs_jobs` | Service jobs with scheduling |
| `portal_tokens` | Customer portal access tokens |
| `estimates` | Job estimates with approval workflow |
| `invoices` | Customer invoices with Stripe integration |
| `business_settings` | Portal branding and business info |
| `fs_inventory_items` | Parts definition and stock levels |
| `fs_job_parts` | Parts used on specific jobs |
| `marketing_templates` | Email/SMS scripts for automation |
| `campaign_logs` | Tracking for automated messages |

---

## Server Actions (`/lib/actions`)

| File | Responsibility |
|------|----------------|
| `jobs.ts` | Job CRUD, status updates |
| `customers.ts` | Customer management |
| `calendar.ts` | Calendar/scheduling operations |
| `job-execution.ts` | Check-in, photos, signatures, completion |
| `portal-auth.ts` | Token generation, validation, email sending |
| `portal-estimates.ts` | Estimate fetch and approval |
| `portal-invoices.ts` | Invoice fetch and payment marking |
| `archive.ts` | Soft delete and restoration |
| `inventory.ts` | Part CRUD and stock management |
| `analytics.ts` | Aggregation queries for dashboard charts |

---

## Supabase Client Usage

### ⚠️ Critical: RLS and Public Access

When implementing public-facing features (like customer portals) that don't require user authentication, the standard `createClient()` function won't work because it uses the **anon key** which is subject to Row Level Security (RLS).

**Solution**: Use `createServiceClient()` from `@/lib/supabase/service`:

```typescript
import { createServiceClient } from '@/lib/supabase/service';

// This bypasses RLS - use only on server-side
const supabase = createServiceClient();
```

### When to Use Each Client

| Client | Use Case | RLS |
|--------|----------|-----|
| `createClient()` | Authenticated user operations | ✅ Enforced |
| `createServiceClient()` | Portal token validation, admin operations, webhooks | ❌ Bypassed |

> ⚠️ **Warning**: Never expose the service role key to the client. Only use `createServiceClient()` in server actions and API routes.

---

## Environment Variables

```bash
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://xxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJ...
SUPABASE_SERVICE_ROLE_KEY=eyJ...  # For bypassing RLS

# Stripe
STRIPE_SECRET_KEY=sk_test_...
STRIPE_PUBLISHABLE_KEY=pk_test_...
STRIPE_WEBHOOK_SECRET=whsec_...

# Email
RESEND_API_KEY=re_...

# Notifications
TWILIO_ACCOUNT_SID=AC...
TWILIO_AUTH_TOKEN=...
TWILIO_PHONE_NUMBER=+1...
```

---

## User Invitation Flow (Troubleshooting)

### **The Core Issue: Implicit vs. PKCE Flow**
Supabase invite emails often use the **Implicit Flow**, where tokens are sent in the URL **Hash** (`#access_token=...`) rather than Query Parameters (`?code=...`).
- **Initial Fail**: We used a **Server-Side Route** (`route.ts`). Server code **cannot see URL hashes**.
- **The Fix**: We switched to a **Client-Side Page** (`page.tsx`) for the callback. This runs in the browser, sees the hash, extracts the token, and sets the session.

### **Secondary Issue: Redirect Loops**
After logging in, the browser entered an infinite loop between `Onboarding` <-> `Dashboard`.
- **Cause**: Client state (authenticated) vs Server Middleware (unauthenticated or incomplete profile) mismatch.
- **The Fix**: Removed auto-redirect. Used a **manual "Go to Dashboard" button** on the Onboarding success screen to break the loop.

### **Architecture for Debugging**
1. **Invite Action**: Sends email with redirect to `/auth/callback/invite`.
2. **Callback Page** (`src/app/auth/callback/invite/page.tsx`): Client-side. Reads `#hash`. Sets Session. Redirects to `/auth/onboarding`.
3. **Onboarding Page** (`src/app/auth/onboarding/page.tsx`): Verifies user. Sets Password. Shows "Go to Dashboard".

---

## Key Components

### UI Components (`/components/ui`)
Based on shadcn/ui - Button, Card, Sheet, Dialog, Table, etc.

### Feature Components
- `job-table.tsx` - Admin job list with status badges
- `job-card-list.tsx` - Mobile-friendly job cards
- `customer-list.tsx` - Customer cards with actions
- `calendar/` - Calendar view with drag-drop

### Portal Components (`/components/portal`)
- `PortalHeader.tsx` - Business branding header
- `EstimateCard.tsx` / `InvoiceCard.tsx` - Action cards
- `EstimateActions.tsx` - Approval with signature
- `InvoicePayment.tsx` - Stripe Checkout integration
- `GeneratePortalLinkButton.tsx` - Admin link generation

### Mobile Components (`/components/mobile`)
- `mobile-job-client.tsx` - Full job execution view
- `signature-pad.tsx` - Customer signature capture
- `task-checklist.tsx` - Job task completion

---

## Testing

### Portal Test URL
- Token: `test-1769132977587`
- URL: http://localhost:3000/portal/test-1769132977587

### Stripe Test Cards
- Success: `4242 4242 4242 4242`
- Decline: `4000 0000 0000 0002`

---

## Common Patterns

### Server Action Pattern
```typescript
'use server';
import { createClient } from '@/lib/supabase/server';

export async function myAction(): Promise<{ success: boolean; error?: string }> {
  const supabase = await createClient();
  // ... database operations
}
```

### Protected Route Pattern
All `/dashboard/*` routes require authentication via Supabase Auth middleware.

### Portal Route Pattern
`/portal/[token]` routes validate token in page component and redirect to `/portal/expired` if invalid.

---

## Map & Location Services

### 1. Map View (`/dashboard/map`)
- **Mapbox GL Integration**: Interactive map using `react-map-gl` v8 with Mapbox GL JS.
- **Job Clustering**: Visualizes all active jobs with location pins.
- **Sidebar Navigation**: List of jobs that "flies to" location on click.

### 2. Address Autocomplete & Validation
- **Strict Validation**: New Jobs (`/dashboard/jobs/new`) require a verified address.
- **Mapbox Search**: Uses `@mapbox/search-js-react` to fetch specific coordinates.
- **Database Storage**: Latitude/Longitude saved directly to `fs_jobs` table.

### ⚠️ Critical: React Map GL v8 Dependencies
The latest `react-map-gl` (v8+) has specific requirements:
1. **Imports**: MUST use subpath imports for ESM compatibility:
   ```typescript
   // CORRECT
   import Map from 'react-map-gl/mapbox';
   
   // INCORRECT (Will cause "Module not found")
   import Map from 'react-map-gl';
   ```
2. **Next.js Config**: Requires transpilation:
   ```typescript
   transpilePackages: ['react-map-gl', 'mapbox-gl'],
   ```
3. **Styles**: Must import `mapbox-gl/dist/mapbox-gl.css`.

---

## Recent Updates (2026-01-25)

### 1. Inventory & Parts Tracking
- **Schema**: Added `fs_inventory_items` and `fs_job_parts`.
- **Logic**: Use RPC `decrement_stock` to safely deduct parts during mobile usage.
- **Invoicing**: Automatically adds used parts to the final invoice generation.
- **Mobile**: Added "Parts Used" section to Mechanic view with specialized combobox.

### 2. Marketing & Automated Retention
- **Edge Function**: Hosted at `supabase/functions/process-marketing-automation` (daily cron).
- **Features**:
  - Review Requests (1 day post-job).
  - Service Reminders (365 days post-job).
  - Anti-spam logging via `campaign_logs`.
- **UI**: Added Settings page for template customization (`/dashboard/settings/marketing`).

### 3. UI/UX Refinements
- **Readability**: Standardized button colors (`bg-slate-700` + white text) for high contrast on dark backgrounds.
- **Forms**: Enforced white labels on Customer Forms to fix dark mode visibility issues.
- **Cleanliness**: Removed redundant headers in Settings sub-pages.

### 4. Technician Assignment & Notifications
- **Server Action**: Implemented `assignJob` in `src/lib/actions/jobs.ts` which updates the job record.
- **Notification**: Helper function `notifyTechnician` sends automated emails via Resend when a job is assigned.
- **Fix**: Adjusted TypeScript types in `notifyTechnician` to correctly handle Supabase relation data (single object vs array).


### 4. Vercel Build Fixes (2026-01-27)
- **Suspense Boundaries**: Wrapped `useSearchParams()` usage in `<Suspense>` for:
  - `/login` (Login Page)
  - `/auth/onboarding` (Invite Flow)
- **Dynamic Rendering**: Added `force-dynamic` to `/dashboard/map/page.tsx` to handle cookie usage in build.
- **Client-Side Libraries**: Wrapped Mapbox `SearchBox` in `AddressAutocomplete.tsx` with `next/dynamic` (`ssr: false`) to prevent `document is not defined` errors.
- **Data Fetching**: Fixed `getJobById` to use `.limit(1)` instead of `.single()` to avoid "Cannot coerce result" errors on relations.

---

## MCP Tools

### Vercel Management
Integrated tools for managing Vercel deployments directly from the agent.

#### `get_vercel_build_logs`
- **Purpose**: Debug failed deployments by fetching build logs.
- **Input**: `deployment_id` (or URL), `team_id` (optional).
- **Features**: Returns last 150 lines, preserves error messages.

#### `list_vercel_deployments`
- **Purpose**: List recent deployments for a project.
- **Input**: `project_id_or_name`, `limit` (limit=5), `team_id` (optional).

#### `get_vercel_deployment_details`
- **Purpose**: Get detailed metadata for a deployment.
- **Input**: `deployment_id`, `team_id` (optional).

#### `set_vercel_env_var`
- **Purpose**: Set or update environment variables.
- **Input**: `project_id`, `key`, `value`, `target` (e.g. `["production"]`), `team_id` (optional).
- **Note**: Handled safely with encryption.

### 5. Public Booking Widget (2026-01-27)
- **Public Route**: `/public/book/[org_id]` for customer self-scheduling.
- **Flow**: Multi-step wizard (Contact -> Service -> Time).
- **Security**: Rate limiting + Honeypot fields (no RLS required for submission).
- **Validation**: Schema-based validation for new leads.

### 6. Invoicing & Estimates (2026-01-27)
- **Quote Builder**:
  - `upsertEstimate` action handles complex JSON line items.
  - UI allows adding from Inventory or Custom items.
  - Generates PDF-ready data structure.
- **Invoice Generation**:
  - **Smart Conversion**: Converts accepted Estimates to Invoices.
  - **Fallback**: Auto-calculates based on Job Duration (Labor) + Parts Used.
  - **Editable**: New `/dashboard/invoices/[id]` page for editing Due Date, Notes, and Status.
- **Schema**:
  - Added `status`, `due_date`, `notes` to `invoices` table.

### 7. UI Standardization & Profile Management (2026-02-01)
- **Design System Consistency**:
  - Refactored **Inventory**, **Payroll**, and **Marketing** modules to match the `Jobs` design language.
  - **Standards**: `bg-slate-800` cards, simple tables with borders, consistent headers (`text-2xl` bold), and gradient actions (`from-blue-600 to-cyan-500`).
  - **Mobile**: Implemented "Card View" pattern for all tables on small screens (< md).
- **Profile Settings**:
  - **Schema**: Expanded `profiles` table with `username`, `phone`, and `address`.
  - **UI**: New `ProfileForm` with Zod validation and read-only Role display.
  - **Features**: Server-side profile updates and password reset trigger.
- **Navigation Cleanup**:

### 8. Payroll & Time Tracking
- **Automated Timesheets**: 
  - Generates payroll runs based on `fs_job_events` (Check-In/Check-Out timestamps).
  - Automatically flags incomplete shifts (Missing Check-Outs) as `draft` for admin review.
  - Auto-approves clean shifts.
- **Calculation Logic**:
  - **Regular Hours**: Up to 40 hours/week.
  - **Overtime**: Excess of 40 hours, calculated at **1.5x** hourly rate.
  - **Gross Pay**: `(Regular * Rate) + (Overtime * Rate * 1.5)`.
- **Schema**:
  - `payroll_runs`: Aggregates a pay period.
  - `timesheets`: Individual technician records per run.
  - Uses `profiles.hourly_rate` for calculations.

---

## Agent Testing Suite & Automated PR Review (2026-02-11)

### Architecture
```
Agent Generates Code → validate_work tool → Pass? → Commit & PR
                                           ↓ Fail
                                       Agent fixes code

PR Opened → pr_review.yml (GitHub Action) → Gemini reviews diff → Comment posted
```

### 1. Generation Validator (`tool_executor/validator.py`)
- **Purpose**: Pre-PR quality gate — runs lint, type-check, and tests inside the Docker sandbox before the agent declares a task complete.
- **Integration**: New `validate_work` Gemini tool declaration in `tool_executor/tools.py`, routed through `orchestrator.py`.
- **Auto-detection**: Identifies project type (Node/Python) from marker files (`package.json`, `requirements.txt`).
- **Checks**:
  - **Node**: `tsc --noEmit`, `eslint`, `npm test`
  - **Python**: `py_compile`, `ruff check`, `pytest`

### 2. PR Review Agent (`pr_agent/`)
- **`reviewer.py`**: Fetches PR diff → sends to Gemini with a structured review prompt → posts formatted comment on the PR.
- **`github_client.py`**: GitHub REST API wrapper for reading diffs and posting reviews.
- **CLI**: `python -m pr_agent.reviewer --repo owner/repo --pr 42 --dry-run`
- **Model**: `gemini-2.5-flash` (configurable via `--model` flag).
- **Review Coverage**: Bugs, security flaws, performance (N+1), code quality, best practices.

### 3. Agent Evaluation Suite (`tests/agent_evals/`)
- **`test_cases.py`**: Gold-standard diffs with known issues (SQL injection, hardcoded secrets, off-by-one, N+1 queries, clean code false-positive check).
- **`test_evaluate.py`**: Pytest harness that runs each case through Gemini and asserts correct flag detection.
- **Run**: `GEMINI_API_KEY=... python -m pytest tests/agent_evals/ -v`

### 4. GitHub Actions Workflows
| Workflow | Trigger | Action |
|----------|---------|--------|
| `.github/workflows/pr_review.yml` | `pull_request` (open/sync/reopen) | Runs `pr_agent/reviewer.py` against the PR |
| `.github/workflows/test_agent.yml` | Push to `main` (agent code changes) or manual | Runs `tests/agent_evals/` to verify reviewer accuracy |

### Required Secrets
| Secret | Where to Set |
|--------|-------------|
| `GEMINI_API_KEY` | GitHub Repo → Settings → Secrets → Actions |
| `GITHUB_TOKEN` | Auto-provided by GitHub Actions |

---

## Token-Aware Memory Synthesis Engine (`memory_engine/`, 2026-02-11)

### Purpose
Prevents context-window overflow by monitoring conversation token weight and flushing old history into a structured `project_memory.md` via rolling LLM synthesis.

### How It Works
1. **Token counting**: `tiktoken` (`cl100k_base`) primary, `len(text)//4` fallback
2. **Threshold**: When history > 100k tokens, oldest 80k are sent to Gemini for synthesis
3. **Merge**: Synthesis prompt explicitly merges new info with existing `project_memory.md` — never overwrites
4. **Output**: Three sections: `## Technical Constraints`, `## Resolved Architecture`, `## Pending Tasks`
5. **Word cap**: Recursive self-summarization if summary > 5,000 words
6. **System prompt**: Automatically prefixed with memory content before base instruction

### Integration
- Initialized in `Orchestrator.__init__` with `MarkdownMemoryStorage`
- `check_and_compress()` called at top of `Orchestrator.run()` before each generate
- `build_system_prompt()` used in `_generate_with_retry()` to inject memory

### Key Classes
| Class | File | Role |
|-------|------|------|
| `TokenCounter` | `memory_engine/token_counter.py` | Count tokens with fallback |
| `MemoryStorage` | `memory_engine/storage.py` | Abstract interface (swappable) |
| `MarkdownMemoryStorage` | `memory_engine/storage.py` | File backend with atomic writes |
| `MemoryCompressor` | `memory_engine/compressor.py` | Threshold logic + synthesis |


